<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dataset Explorer</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>Dataset Explorer</h1>
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Search datasets...">
  </div>
  <div class="tags" id="tags-container">
    <!-- Tags will be dynamically inserted here -->
  </div>
  <div class="sort-bar">
    <label for="sort-select">Sort by:</label>
    <select id="sort-select">
      <option value="name">Name (A-Z)</option>
      <option value="date_latest">Date (Latest)</option>
      <option value="date_earliest">Date (Earliest)</option>
    </select>
  </div>
  <div id="datasets-container">
    <!-- Matching datasets will be displayed here -->
  </div>

  <script>
    const datasets = JSON.parse('{{ datasets | tojson | safe }}');
    const tagData = JSON.parse('{{ tags | tojson | safe }}');
    let searchTerm = '';
    let selectedTags = [];

    // Filter datasets by search term and selected tags.
    const updateView = () => {
      const filtered = datasets.filter(dataset => {
        const matchesSearch = !searchTerm || 
          (dataset.name && dataset.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
          (dataset.summary && dataset.summary.toLowerCase().includes(searchTerm.toLowerCase())) ||
          (dataset.notes && dataset.notes.toLowerCase().includes(searchTerm.toLowerCase()));
        const matchesTags = selectedTags.length === 0 ||
          (Array.isArray(dataset.tags) && selectedTags.every(tag => dataset.tags.includes(tag)));
        return matchesSearch && matchesTags;
      });
      
      renderDatasets(filtered);
    };

    // Sort datasets 
    function updateOrder() {
      const sortOption = document.getElementById("sort-select").value;
      console.log("Sorting datasets by:", sortOption);
      datasets.sort((a, b) => {
        if (sortOption === "name") return a.name.localeCompare(b.name);
        if (sortOption === "date_latest") return new Date(b.date) - new Date(a.date);
        if (sortOption === "date_earliest") return new Date(a.date) - new Date(b.date);
      });
      updateView();
    }

    // Render dataset elements.
    function renderDatasets(list) {
      const container = document.getElementById("datasets-container");
      container.innerHTML = "";

      console.log(`Rendering ${list.length} datasets...`);

      list.forEach(dataset => {
        const elem = document.createElement("div");
        elem.className = "dataset";

        elem.innerHTML = `
          <div class="dataset-minimal">
            <div class="dataset-title">${dataset.name}</div>
            <div class="dataset-detail"><strong>Summary:</strong> ${dataset.summary}</div>
            <div class="dataset-detail"><strong>Size:</strong> ${dataset.size}</div>
            <div class="dataset-detail"><strong>Date Created:</strong> ${dataset.date || "N/A"}</div>
          </div>
          <div class="dataset-full" style="display: none;">
            <div class="dataset-detail"><strong>Download Location:</strong> <a href="${dataset.download}" target="_blank">${dataset.download}</a></div>
            <div class="dataset-detail"><strong>Notes:</strong> ${dataset.notes}</div>
            <div class="dataset-detail"><strong>Companion Paper:</strong> ${
              dataset.companion === "Not available"
                ? "Not available"
                : `<a href="${dataset.companion}" target="_blank">${dataset.companion}</a>`
            }</div>
            <div class="dataset-detail"><strong>Tags:</strong> ${renderDatasetTags(dataset.tags)}</div>
          </div>
        `;

        // Toggle full details on click.
        elem.addEventListener("click", () => {
          const details = elem.querySelector(".dataset-full");
          details.style.display = details.style.display === "block" ? "none" : "block";
        });

        container.appendChild(elem);
      });
    };

    // Render and handle tag buttons with tooltips.
    function renderTags() {
      const container = document.getElementById("tags-container");
      container.innerHTML = "";

      // Iterate over the array to preserve order.
      tagData.forEach(groupObj => {
        const groupContainer = document.createElement("div");
        groupContainer.className = "tag-group-line";

        const header = document.createElement("span");
        header.className = "tag-group-header";
        header.textContent = `${groupObj.group}: `;
        groupContainer.appendChild(header);

        // Iterate over tags within the group.
        Object.keys(groupObj.tags).forEach(tag => {
          const tagElem = document.createElement("span");
          tagElem.className = "tag";
          tagElem.textContent = tag;
          tagElem.setAttribute("data-tooltip", groupObj.tags[tag]);
          tagElem.style.cursor = "pointer";

          tagElem.addEventListener("click", e => {
            e.stopPropagation();
            tagElem.classList.toggle("selected");
            const tagText = tagElem.textContent;
            selectedTags = tagElem.classList.contains("selected")
              ? [...selectedTags, tagText]
              : selectedTags.filter(t => t !== tagText);
            updateView();
          });

          groupContainer.appendChild(tagElem);
          groupContainer.appendChild(document.createTextNode(" "));
        });

        container.appendChild(groupContainer);
      });
    }

    function renderDatasetTags(tags) {
      if (!tags) return "";
      return tags.map(tag => {
        let tooltip = "";
        for (let group in tagData) {
          if (tagData[group][tag]) {
            tooltip = tagData[group][tag];
            break;
          }
        }
        return `<span class="tag" data-tooltip="${tooltip}">${tag}</span>`;
      }).join(" ");
    };

    // Event listeners for sort and search.
    document.getElementById("sort-select").addEventListener("change", updateOrder);
    document.getElementById("search-input").addEventListener("input", e => {
      searchTerm = e.target.value;
      updateView();
    });

    // Initialize the page.
    renderTags();
    updateOrder();
    updateView();

  </script>
  <script src="{{ url_for('static', filename='tooltip.js') }}"></script>
</body>
</html>
